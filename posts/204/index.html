<!doctype html><html lang=en><head><title>S32V平台uImge文件生成问题 · Hd's Blog</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=author content="shuiyuehd"><meta name=description content="Hd's personal website"><meta name=keywords content="blog,developer,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content="S32V平台uImge文件生成问题"><meta name=twitter:description content><meta property="og:title" content="S32V平台uImge文件生成问题"><meta property="og:description" content><meta property="og:type" content="article"><meta property="og:url" content="https://blog.shuiyuehd.cn/posts/204/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2016-11-16T00:00:00+00:00"><meta property="article:modified_time" content="2016-11-16T00:00:00+00:00"><meta property="og:see_also" content="https://blog.shuiyuehd.cn/posts/207/"><link rel=canonical href=https://blog.shuiyuehd.cn/posts/204/><link rel=preload href="/fonts/forkawesome-webfont.woff2?v=1.2.0" as=font type=font/woff2 crossorigin><link rel=stylesheet href=/css/coder.min.c4d7e93a158eda5a65b3df343745d2092a0a1e2170feeec909b8a89443903c6a.css integrity="sha256-xNfpOhWO2lpls980N0XSCSoKHiFw/u7JCbiolEOQPGo=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/coder-dark.min.78b5fe3864945faf5207fb8fe3ab2320d49c3365def0e88ac1df0ddadc54a03c.css integrity="sha256-eLX+OGSUX69SB/uP46sjINScM2Xe8OiKwd8N2txUoDw=" crossorigin=anonymous media=screen><link rel=stylesheet href=/scss/css/custom.min.5ee0ad9e8f1b17d7a2309a71c69cb872e2afd31d618222760117de63b651a440.css integrity="sha256-XuCtno8bF9eiMJpxxpy4cuKv0x1hgiJ2ARfeY7ZRpEA=" crossorigin=anonymous media=screen><link rel=stylesheet href=/scss/custom.min.85f403ff232218bd8e612424d1885bb4d57fd440764fa75faecb6ceb511c75b4.css integrity="sha256-hfQD/yMiGL2OYSQk0YhbtNV/1EB2T6dfrsts61EcdbQ=" crossorigin=anonymous media=screen><link rel=icon type=image/png href=/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/images/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/images/safari-pinned-tab.svg color=#5bbad5><meta name=generator content="Hugo 0.105.0"></head><body class="preload-transitions colorscheme-auto"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=/>Hd's Blog</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/about/>About</a></li><li class=navigation-item><a class=navigation-link href=/posts/>Posts</a></li><li class=navigation-item><a class=navigation-link href=/contact/>Contact</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://blog.shuiyuehd.cn/posts/204/>S32V平台uImge文件生成问题</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa fa-calendar" aria-hidden=true></i>
<time datetime=2016-11-16T00:00:00Z>2016-11-16</time></span>
<span class=reading-time><i class="fa fa-clock-o" aria-hidden=true></i>
2-minute read</span></div><div class=categories><i class="fa fa-folder" aria-hidden=true></i>
<a href=/categories/s32v/>s32v</a></div><div class=tags><i class="fa fa-tag" aria-hidden=true></i>
<span class=tag><a href=/tags/s32v/>s32v</a></span>
<span class=separator>•</span>
<span class=tag><a href=/tags/image/>Image</a></span>
<span class=separator>•</span>
<span class=tag><a href=/tags/uimage/>uImage</a></span></div></div></header><div><h3 id=平台信息>平台信息
<a class=heading-link href=#%e5%b9%b3%e5%8f%b0%e4%bf%a1%e6%81%af><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><blockquote><p>Boot：u-boot-2016.01_bsp10.0</p><p>内核：linux-4.1.26_bsp10.0</p></blockquote><h3 id=uboot编译>uboot编译
<a class=heading-link href=#uboot%e7%bc%96%e8%af%91><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>$ export ARCH=aarch64
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>$ export CROSS_COMPILE=/opt /gcc-linaro-4.9-2014.11-x86_64_aarch64-linux-gnu/bin/aarch64-linux-gnu-
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>$ make s32v234evb_config
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>$ make 						
</span></span></code></pre></div><h3 id=kernel编译>kernel编译
<a class=heading-link href=#kernel%e7%bc%96%e8%af%91><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>$ <span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>ARCH</span><span style=color:#ff79c6>=</span>arm64
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#8be9fd;font-style:italic>$export</span> <span style=color:#8be9fd;font-style:italic>CROSS_COMPILE</span><span style=color:#ff79c6>=</span>/opt /gcc-linaro-4.9-2014.11-x86_64_aarch64-linux-gnu/bin/aarch64-linux-gnu-
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>$ make s32v234_defconfig 
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>$ make all
</span></span></code></pre></div><h3 id=模块安装>模块安装
<a class=heading-link href=#%e6%a8%a1%e5%9d%97%e5%ae%89%e8%a3%85><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>$ make modules
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>$ make <span style=color:#8be9fd;font-style:italic>INSTALL_MOD_PATH</span><span style=color:#ff79c6>=</span>./modules modules_install 
</span></span></code></pre></div><h3 id=uimage配置>uImage配置
<a class=heading-link href=#uimage%e9%85%8d%e7%bd%ae><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>mkimage -A arm64  -O linux -T kernel -C none -a 0xC80080000 -e 0xC80080000 -n <span style=color:#f1fa8c>&#34;Linux test s32v234-evb&#34;</span>  -d arch/arm64/boot/Image uImage
</span></span></code></pre></div><p>这个时候会报错：</p><figure><img src=https://raw.githubusercontent.com/shuiyuehd/picgo/main/img/2022/10/18/pic-20221018143348.jpeg></figure><blockquote><p>以上就是我的执行的流程。我刚刚开始认为我的mkimage参数不正确，所以我花了点时间专门研究了这个工具的参数的配置选项和相关的意义，然后我就将arch参数改为了arm这个时候我完全可以编译出的，这就证明了我的参数是配置正确的，然后我就开始怀疑是不是本身这套代码的框架上不支持arm64的框架，这个是很正常的，通过报错提示也说明他不支持。我就查询了相关文档找到了如何添加框架补丁的修改文档，我发现这个框架数据结构早就添加了ARM64的框架。</p></blockquote><p>在/common/image.c的框架结构体是支持的：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#ff79c6>static</span> <span style=color:#ff79c6>const</span> table_entry_t uimage_arch[] <span style=color:#ff79c6>=</span> {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    {	IH_ARCH_INVALID,	<span style=color:#8be9fd;font-style:italic>NULL</span>,		<span style=color:#f1fa8c>&#34;Invalid ARCH&#34;</span>,	},
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    {	IH_ARCH_ALPHA,		<span style=color:#f1fa8c>&#34;alpha&#34;</span>,	<span style=color:#f1fa8c>&#34;Alpha&#34;</span>,	  },
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    {	IH_ARCH_ARM,		<span style=color:#f1fa8c>&#34;arm&#34;</span>,		<span style=color:#f1fa8c>&#34;ARM&#34;</span>,		  },
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    {	IH_ARCH_I386,		<span style=color:#f1fa8c>&#34;x86&#34;</span>,		<span style=color:#f1fa8c>&#34;Intel x86&#34;</span>,	},
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    {	IH_ARCH_IA64,		<span style=color:#f1fa8c>&#34;ia64&#34;</span>,		<span style=color:#f1fa8c>&#34;IA64&#34;</span>,			},
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    {	IH_ARCH_M68K,		<span style=color:#f1fa8c>&#34;m68k&#34;</span>,		<span style=color:#f1fa8c>&#34;M68K&#34;</span>,			},
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    {	IH_ARCH_MICROBLAZE,	<span style=color:#f1fa8c>&#34;microblaze&#34;</span>,	<span style=color:#f1fa8c>&#34;MicroBlaze&#34;</span>,},
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    {	IH_ARCH_MIPS,		<span style=color:#f1fa8c>&#34;mips&#34;</span>,		<span style=color:#f1fa8c>&#34;MIPS&#34;</span>,			},
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    {	IH_ARCH_MIPS64,		<span style=color:#f1fa8c>&#34;mips64&#34;</span>,	<span style=color:#f1fa8c>&#34;MIPS 64 Bit&#34;</span>,	},
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    {	IH_ARCH_NIOS2,		<span style=color:#f1fa8c>&#34;nios2&#34;</span>,	<span style=color:#f1fa8c>&#34;NIOS II&#34;</span>,		},
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    {	IH_ARCH_PPC,		<span style=color:#f1fa8c>&#34;powerpc&#34;</span>,	<span style=color:#f1fa8c>&#34;PowerPC&#34;</span>,		},
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    {	IH_ARCH_PPC,		<span style=color:#f1fa8c>&#34;ppc&#34;</span>,		<span style=color:#f1fa8c>&#34;PowerPC&#34;</span>,		},
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>    {	IH_ARCH_S390,		<span style=color:#f1fa8c>&#34;s390&#34;</span>,		<span style=color:#f1fa8c>&#34;IBM S390&#34;</span>,		},
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>    {	IH_ARCH_SH,		  <span style=color:#f1fa8c>&#34;sh&#34;</span>,		<span style=color:#f1fa8c>&#34;SuperH&#34;</span>,		},
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>    {	IH_ARCH_SPARC,		<span style=color:#f1fa8c>&#34;sparc&#34;</span>,	<span style=color:#f1fa8c>&#34;SPARC&#34;</span>,		},
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>    {	IH_ARCH_SPARC64,	<span style=color:#f1fa8c>&#34;sparc64&#34;</span>,	<span style=color:#f1fa8c>&#34;SPARC 64 Bit&#34;</span>,	},
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>    {	IH_ARCH_BLACKFIN,	<span style=color:#f1fa8c>&#34;blackfin&#34;</span>,	<span style=color:#f1fa8c>&#34;Blackfin&#34;</span>,		},
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>    {	IH_ARCH_AVR32,		<span style=color:#f1fa8c>&#34;avr32&#34;</span>,	<span style=color:#f1fa8c>&#34;AVR32&#34;</span>,		},
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>    {	IH_ARCH_NDS32,		<span style=color:#f1fa8c>&#34;nds32&#34;</span>,	<span style=color:#f1fa8c>&#34;NDS32&#34;</span>,		},
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>    {	IH_ARCH_OPENRISC,	<span style=color:#f1fa8c>&#34;or1k&#34;</span>,		<span style=color:#f1fa8c>&#34;OpenRISC 1000&#34;</span>,},
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>    {	IH_ARCH_SANDBOX,	<span style=color:#f1fa8c>&#34;sandbox&#34;</span>,	<span style=color:#f1fa8c>&#34;Sandbox&#34;</span>,		},
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span> 	{	IH_ARCH_ARM64,		<span style=color:#f1fa8c>&#34;arm64&#34;</span>,	<span style=color:#f1fa8c>&#34;AArch64&#34;</span>,		},	<span style=color:#6272a4>// 这个是我们预期的配置
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span><span style=color:#6272a4></span>    {	IH_ARCH_ARC,		<span style=color:#f1fa8c>&#34;arc&#34;</span>,		<span style=color:#f1fa8c>&#34;ARC&#34;</span>,			},
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>    {	IH_ARCH_X86_64,		<span style=color:#f1fa8c>&#34;x86_64&#34;</span>,	<span style=color:#f1fa8c>&#34;AMD x86_64&#34;</span>,	},
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>    {	<span style=color:#ff79c6>-</span><span style=color:#bd93f9>1</span>,					<span style=color:#f1fa8c>&#34;&#34;</span>,			<span style=color:#f1fa8c>&#34;&#34;</span>,				},
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>};
</span></span></code></pre></div><p>这个时候我开始迷糊了。</p><p>最后我就将报错信息一一定位到具体的代码中去，这个过程废了很长时间，我将整个64K头的解析匹配我都找到了，我本来是想直接写死框架，但是这个处理很不好也没有成功，一旦你不指定-A的时候就会默认为<code>PowerPC</code>，于是我就将<code>PowerPC</code>的位置和<code>arm64</code>的位置调换了，就可以了。</p><p>我打开了我编译出的mkimage文件：vi mkimage，也是支持arm64的呢。</p><p>下边是他的执行流程：<code>-A</code> 支持的框架就是圈红的地方。和代码中写的框架还是有出入的。</p><p>这个里面的打印信息都是我自己调试的时候添加上去的。保留着也好，能够清晰的看到他执行的时候的匹配过程。</p></div><footer><section class=see-also><h3 id=see-also-in-s32v>See also in s32v
<a class=heading-link href=#see-also-in-s32v><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><nav><ul><li><a href=/posts/207/>S32V管脚理解</a></li></ul></nav></section><div class=comments><script>let getTheme=window.localStorage&&window.localStorage.getItem("colorscheme");getTheme=getTheme??"preferred-color-scheme";let theme=getTheme==="dark"?"github-dark":"github-light",s=document.createElement("script");s.src="https://utteranc.es/client.js",s.setAttribute("repo","shuiyuehd/blog-comment"),s.setAttribute("issue-term","pathname"),s.setAttribute("theme",theme),s.setAttribute("crossorigin","anonymous"),s.setAttribute("async",""),document.querySelector("div.comments").innerHTML="",document.querySelector("div.comments").appendChild(s)</script></div></footer></article></section></div><footer class=footer><section class=container>©
2022
shuiyuehd
·
Powered by <a href=https://gohugo.io/>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/>Coder</a>.</section></footer></main><script src=/js/coder.min.236049395dc3682fb2719640872958e12f1f24067bb09c327b233e6290c7edac.js integrity="sha256-I2BJOV3DaC+ycZZAhylY4S8fJAZ7sJwyeyM+YpDH7aw="></script></body></html>